name: Deploy Application to Kubernetes
description: >
  Detect Kubernetes manifests in the current repository, select an environment
  and namespace, and apply the configuration to a chosen cluster without relying
  on hard-coded paths.

triggers:
  - user_request: "deploy to kubernetes"
  - user_request: "apply k8s manifests"
  - user_request: "roll out to dev/staging/prod"

assumptions:
  - The user has at least one kubeconfig context configured. [web:94]
  - The repository contains or will contain Kubernetes manifests or Helm/Kustomize configuration.

steps:
  - name: Discover k8s configuration
    action: analyze_repository
    description: >
      Search for Kubernetes-related directories such as `k8s/`, `manifests/`,
      `deploy/`, `infra/`, `helm/`, or `overlays/` under the workspace root.
      If multiple candidates exist, ask the user which directory to use.

  - name: Select environment and namespace
    action: choose_environment
    description: >
      Prompt the user to select an environment (for example, dev, staging, prod)
      and namespace. Suggest sensible defaults like `dev` for non-critical
      deployments. [web:85][web:91]

  - name: Select kubeconfig context
    action: choose_context
    description: >
      List available kubeconfig contexts and ask the user to choose the target
      context for deployment. Do not rely on implicit current context. [web:94]

  - name: Plan deployment method
    action: decide_strategy
    description: >
      Determine whether to use:
        - Plain manifests with `kubectl apply`.
        - Helm (if `Chart.yaml` is present).
        - Kustomize (if `kustomization.yaml` is present).
      Based on the repository structure and user preference.

  - name: Render configuration (if needed)
    action: render_config
    description: >
      For Helm or Kustomize, render the final manifests for the selected
      environment so they can be inspected before apply.

  - name: Apply configuration
    action: shell_command
    command_template: >
      kubectl --context {{ context }} --namespace {{ namespace }} apply -f {{ config_path }}
    notes: >
      Use relative paths to configuration directories. For Helm, use
      `helm upgrade --install` with environment-specific values files.

  - name: Verify rollout
    action: shell_command
    command_template: >
      kubectl --context {{ context }} --namespace {{ namespace }} get pods,deploy,svc
    notes: >
      Optionally run `kubectl rollout status` for Deployments or StatefulSets
      and summarize any issues.

  - name: Summarize deployment
    action: summarize
    description: >
      Provide a summary of what was deployed, which context and namespace were
      used, and how the user can check logs, status, and roll back changes.
