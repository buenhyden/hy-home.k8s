name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # 1. Lint & Validation Job
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python (for yamllint)
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install yamllint
        run: pip install yamllint

      - name: Lint YAML files
        run: yamllint .
        continue-on-error: true # 처음에는 에러가 많을 수 있으므로 경고만 발생

      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes Manifests
        # k8s 디렉토리 내의 yaml 파일 검사
        run: kubeconform -summary -ignore-missing-schemas k8s/

  # 2. Kind E2E Test Job
  e2e-test:
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1.9.0
        with:
          config: k8s/cluster-config/kind-config.yaml # 레포에 있는 kind 설정 사용

      - name: Install Argo CD
        run: |
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

          # Argo CD 서버가 준비될 때까지 대기 (최대 5분)
          kubectl wait --for=condition=available deployment/argocd-server -n argocd --timeout=300s

      - name: Verify Argo CD Pods
        run: kubectl get pods -n argocd

      - name: Apply Application Manifests (Dry Run)
        # 실제 배포 전 Dry Run으로 테스트
        run: |
          kubectl apply --dry-run=client -f k8s/apps/ -R
