name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-markdown:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: "**/*.md"

  lint-actions:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Run actionlint
        uses: reviewdog/action-actionlint@v1
      - name: Download actionlint
        id: get_actionlint
        run: |
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
        shell: bash
      - name: Check workflow files
        run: ${{ steps.get_actionlint.outputs.executable }} -color
        shell: bash

  lint-shell:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
      - name: Install shell tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          go install mvdan.cc/sh/v3/cmd/shfmt@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          curl -sSL https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 -o /usr/local/bin/hadolint
          sudo chmod +x /usr/local/bin/hadolint
          pwsh -NoProfile -Command "Install-Module -Name PSScriptAnalyzer -Scope CurrentUser -Force"
      - name: Lint shell scripts
        run: |
          mapfile -t shell_files < <(git ls-files '*.sh')
          if [ ${#shell_files[@]} -gt 0 ]; then
            shfmt -d -i 2 "${shell_files[@]}"
            shellcheck -x "${shell_files[@]}"
          else
            echo "No shell scripts detected."
          fi
      - name: Lint Dockerfiles
        run: |
          mapfile -t dockerfiles < <(git ls-files '*Dockerfile')
          if [ ${#dockerfiles[@]} -gt 0 ]; then
            hadolint --config .hadolint.yaml "${dockerfiles[@]}"
          else
            echo "No Dockerfiles detected."
          fi
      - name: Analyze PowerShell
        run: |
          mapfile -t ps_files < <(git ls-files '*.ps1')
          if [ ${#ps_files[@]} -gt 0 ]; then
            pwsh -NoProfile -File scripts/psscriptanalyzer.ps1 "${ps_files[@]}"
          else
            echo "No PowerShell files detected."
          fi

  lint-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"
      - name: Install linters
        run: python -m pip install ruff mypy
      - name: Ruff
        working-directory: apps/_examples/demo-backend/app
        run: ruff check .
      - name: Mypy
        working-directory: apps/_examples/demo-backend/app
        run: mypy .

  validate-k8s:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - name: Validate Kubernetes Manifests
        uses: stackrox/kube-linter-action@v1
        with:
          directory: .
          config: .kube-linter.yaml
